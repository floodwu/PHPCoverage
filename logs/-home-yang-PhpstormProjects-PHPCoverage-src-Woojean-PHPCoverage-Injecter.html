
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style>
html,body,div,span,iframe{
	margin: 0;
	padding: 0;
}

html,body{
	height: 100%;
	font-family: "Microsoft YaHei" ! important;
}

.e{
	background-color:#F0F0F0;
}

.c{
	background-color:#B4EEB4;
}

.u{
	background-color:#FFFAF0;
}

.k{
	font-weight:bold;
	color:blue;
}

.line_num{
	font-size:0.8em;
}

table {
	font-size:0.8em;
}

</style>
</head>
<body>
	<table><tr class="u"><td class="line_num">1</td><td ><label class="k">namespace&nbsp;</label>Woojean\PHPCoverage;</td></tr><tr class="e"><td class="line_num">2</td><td ></td></tr><tr class="u"><td class="line_num">3</td><td ><label class="k">use&nbsp;</label>Redis;</td></tr><tr class="e"><td class="line_num">4</td><td ></td></tr><tr class="u"><td class="line_num">5</td><td ><label class="k">class&nbsp;</label>Injecter{</td></tr><tr class="u"><td class="line_num">6</td><td >&nbsp;<label class="k">public&nbsp;</label><label class="k">static&nbsp;</label>$callback;</td></tr><tr class="e"><td class="line_num">7</td><td ></td></tr><tr class="e"><td class="line_num">8</td><td >&nbsp;//&nbsp;$logDir&nbsp;覆盖率日志目录</td></tr><tr class="e"><td class="line_num">9</td><td >&nbsp;//&nbsp;$ignoreFiles&nbsp;需要忽略的目录、文件列表</td></tr><tr class="e"><td class="line_num">10</td><td >&nbsp;//&nbsp;$repeat&nbsp;是否累加测试（累加测试期间，代码文件不应该变动，否则影响覆盖率行的判断）</td></tr><tr class="u"><td class="line_num">11</td><td >&nbsp;<label class="k">public&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>Inject($config=[]){</td></tr><tr class="u"><td class="line_num">12</td><td >&nbsp;$logDir&nbsp;=&nbsp;isset($config['log_dir'])&nbsp;?&nbsp;$config['log_dir']&nbsp;:&nbsp;'';</td></tr><tr class="u"><td class="line_num">13</td><td >&nbsp;$ignoreFile&nbsp;=&nbsp;isset($config['ignore_file'])&nbsp;?&nbsp;$config['ignore_file']&nbsp;:&nbsp;'';</td></tr><tr class="u"><td class="line_num">14</td><td >&nbsp;$isRepeat&nbsp;=&nbsp;isset($config['is_repeat'])&nbsp;?&nbsp;$config['is_repeat']&nbsp;:&nbsp;False;</td></tr><tr class="e"><td class="line_num">15</td><td ></td></tr><tr class="u"><td class="line_num">16</td><td >&nbsp;if(!is_writable($logDir)){</td></tr><tr class="u"><td class="line_num">17</td><td >&nbsp;<label class="k">echo&nbsp;</label>('PHPCoverage&nbsp;config&nbsp;err<label class="k">or&nbsp;</label>：log&nbsp;dir&nbsp;"<u>'.$logDir.'</u>"&nbsp;can&nbsp;not&nbsp;be&nbsp;null&nbsp;<label class="k">and&nbsp;</label>must&nbsp;be&nbsp;writable&nbsp;!');</td></tr><tr class="u"><td class="line_num">18</td><td >&nbsp;exit(0);</td></tr><tr class="e"><td class="line_num">19</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">20</td><td ></td></tr><tr class="u"><td class="line_num">21</td><td >&nbsp;if(!empty($ignoreFile)&nbsp;&&&nbsp;!file_exists($ignoreFile)){</td></tr><tr class="u"><td class="line_num">22</td><td >&nbsp;<label class="k">echo&nbsp;</label>('PHPCoverage&nbsp;config&nbsp;err<label class="k">or&nbsp;</label>：ignore&nbsp;file&nbsp;"<u>'.$ignoreFile.'</u>"&nbsp;is&nbsp;not&nbsp;exists&nbsp;!');</td></tr><tr class="e"><td class="line_num">23</td><td >&nbsp;</td></tr><tr class="e"><td class="line_num">24</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">25</td><td ></td></tr><tr class="u"><td class="line_num">26</td><td >&nbsp;if(!$isRepeat){</td></tr><tr class="u"><td class="line_num">27</td><td >&nbsp;ClearDir($config['log_dir']);</td></tr><tr class="e"><td class="line_num">28</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">29</td><td ></td></tr><tr class="u"><td class="line_num">30</td><td >&nbsp;<label class="k">if&nbsp;</label>(function_exists('xdebug_start_code_coverage'))&nbsp;{</td></tr><tr class="u"><td class="line_num">31</td><td >&nbsp;xdebug_start_code_coverage();</td></tr><tr class="c"><td class="line_num">32</td><td>&nbsp;register_shutdown_function("Woojean\\PHPCoverage\\Injecter::GatherUsingRedis",$logDir,$ignoreFile);</td></tr><tr class="u"><td class="line_num">33</td><td >&nbsp;#register_shutdown_function("Woojean\\PHPCoverage\\Injecter::Gather",$logDir,$ignoreFile);</td></tr><tr class="e"><td class="line_num">34</td><td >&nbsp;}</td></tr><tr class="u"><td class="line_num">35</td><td >&nbsp;else{</td></tr><tr class="u"><td class="line_num">36</td><td >&nbsp;<label class="k">echo&nbsp;</label>('PHPCoverage&nbsp;config&nbsp;err<label class="k">or&nbsp;</label>：xdebug&nbsp;unreachable&nbsp;!');</td></tr><tr class="u"><td class="line_num">37</td><td >&nbsp;exit(0);</td></tr><tr class="e"><td class="line_num">38</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">39</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">40</td><td ></td></tr><tr class="e"><td class="line_num">41</td><td ></td></tr><tr class="u"><td class="line_num">42</td><td >&nbsp;<label class="k">public&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>Gather($logDir,$ignoreFile){</td></tr><tr class="u"><td class="line_num">43</td><td >&nbsp;$coverageData&nbsp;=&nbsp;xdebug_get_code_coverage();</td></tr><tr class="u"><td class="line_num">44</td><td >&nbsp;xdebug_stop_code_coverage();</td></tr><tr class="u"><td class="line_num">45</td><td >&nbsp;$coverageFile&nbsp;=&nbsp;sprintf('%s/%s.coverage',&nbsp;$logDir,&nbsp;uniqid());</td></tr><tr class="u"><td class="line_num">46</td><td >&nbsp;file_put_contents($coverageFile,json_encode($coverageData));</td></tr><tr class="u"><td class="line_num">47</td><td >&nbsp;self::Reporter($logDir,$ignoreFile);</td></tr><tr class="e"><td class="line_num">48</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">49</td><td ></td></tr><tr class="u"><td class="line_num">50</td><td >&nbsp;<label class="k">public&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>GatherUsingRedis($logDir,$ignoreFile){</td></tr><tr class="c"><td class="line_num">51</td><td>&nbsp;$coverageData&nbsp;=&nbsp;xdebug_get_code_coverage();</td></tr><tr class="u"><td class="line_num">52</td><td >&nbsp;xdebug_stop_code_coverage();</td></tr><tr class="u"><td class="line_num">53</td><td >&nbsp;$redis&nbsp;=&nbsp;<label class="k">new&nbsp;</label>Redis();</td></tr><tr class="u"><td class="line_num">54</td><td >&nbsp;$redis->connect('127.0.0.1',&nbsp;6379);</td></tr><tr class="u"><td class="line_num">55</td><td >&nbsp;<label class="k">echo&nbsp;</label>"Connection&nbsp;to&nbsp;server&nbsp;successfully...\n";</td></tr><tr class="u"><td class="line_num">56</td><td >&nbsp;<label class="k">foreach&nbsp;</label>($coverageData&nbsp;<label class="k">as&nbsp;</label>$fileName&nbsp;=>&nbsp;$fileData){</td></tr><tr class="u"><td class="line_num">57</td><td >&nbsp;<label class="k">foreach&nbsp;</label>($fileData&nbsp;<label class="k">as&nbsp;</label>$line&nbsp;=>&nbsp;$status){</td></tr><tr class="u"><td class="line_num">58</td><td >&nbsp;if($status&nbsp;==&nbsp;1){</td></tr><tr class="u"><td class="line_num">59</td><td >&nbsp;$redis->sAdd($fileName,$line);</td></tr><tr class="e"><td class="line_num">60</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">61</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">62</td><td >&nbsp;}</td></tr><tr class="u"><td class="line_num">63</td><td >&nbsp;self::Reporter($logDir,$ignoreFile);</td></tr><tr class="e"><td class="line_num">64</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">65</td><td ></td></tr><tr class="u"><td class="line_num">66</td><td >&nbsp;<label class="k">private&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>Reporter($logDir,$ignoreFile){</td></tr><tr class="e"><td class="line_num">67</td><td >&nbsp;<label class="k">require_once&nbsp;</label>'Reporter.php';&nbsp;//&nbsp;!</td></tr><tr class="u"><td class="line_num">68</td><td >&nbsp;$reporter&nbsp;=&nbsp;<label class="k">new&nbsp;</label>Reporter($logDir,$ignoreFile);</td></tr><tr class="u"><td class="line_num">69</td><td >&nbsp;$reporter->report();</td></tr><tr class="e"><td class="line_num">70</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">71</td><td ></td></tr><tr class="e"><td class="line_num">72</td><td ></td></tr><tr class="u"><td class="line_num">73</td><td >&nbsp;<label class="k">private&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>ClearDir($dir)&nbsp;{</td></tr><tr class="u"><td class="line_num">74</td><td >&nbsp;$dh&nbsp;=&nbsp;opendir($dir);</td></tr><tr class="u"><td class="line_num">75</td><td >&nbsp;<label class="k">while&nbsp;</label>($file=readdir($dh))&nbsp;{</td></tr><tr class="u"><td class="line_num">76</td><td >&nbsp;if($file!="."&nbsp;&&&nbsp;$file!="..")&nbsp;{</td></tr><tr class="u"><td class="line_num">77</td><td >&nbsp;$fullpath=$dir."/".$file;</td></tr><tr class="u"><td class="line_num">78</td><td >&nbsp;if(!is_dir($fullpath))&nbsp;{</td></tr><tr class="u"><td class="line_num">79</td><td >&nbsp;unlink($fullpath);</td></tr><tr class="u"><td class="line_num">80</td><td >&nbsp;}&nbsp;<label class="k">else&nbsp;</label>{</td></tr><tr class="u"><td class="line_num">81</td><td >&nbsp;ClearDir($fullpath);</td></tr><tr class="e"><td class="line_num">82</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">83</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">84</td><td >&nbsp;}</td></tr><tr class="u"><td class="line_num">85</td><td >&nbsp;closedir($dh);</td></tr><tr class="e"><td class="line_num">86</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">87</td><td ></td></tr><tr class="e"><td class="line_num">88</td><td ></td></tr><tr class="u"><td class="line_num">89</td><td >&nbsp;<label class="k">private&nbsp;</label><label class="k">static&nbsp;</label><label class="k">function&nbsp;</label>GetPhpCode($src)&nbsp;{</td></tr><tr class="u"><td class="line_num">90</td><td >&nbsp;$dh&nbsp;=&nbsp;opendir($dir);</td></tr><tr class="u"><td class="line_num">91</td><td >&nbsp;<label class="k">while&nbsp;</label>($file=readdir($dh))&nbsp;{</td></tr><tr class="u"><td class="line_num">92</td><td >&nbsp;if($file!="."&nbsp;&&&nbsp;$file!="..")&nbsp;{</td></tr><tr class="u"><td class="line_num">93</td><td >&nbsp;$fullpath=$dir."/".$file;</td></tr><tr class="u"><td class="line_num">94</td><td >&nbsp;var_dump($fullpath);</td></tr><tr class="u"><td class="line_num">95</td><td >&nbsp;if(!is_dir($fullpath))&nbsp;{</td></tr><tr class="u"><td class="line_num">96</td><td >&nbsp;unlink($fullpath);</td></tr><tr class="u"><td class="line_num">97</td><td >&nbsp;}&nbsp;<label class="k">else&nbsp;</label>{</td></tr><tr class="u"><td class="line_num">98</td><td >&nbsp;ClearDir($fullpath);</td></tr><tr class="e"><td class="line_num">99</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">100</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">101</td><td >&nbsp;}</td></tr><tr class="u"><td class="line_num">102</td><td >&nbsp;closedir($dh);</td></tr><tr class="e"><td class="line_num">103</td><td >&nbsp;}</td></tr><tr class="e"><td class="line_num">104</td><td ></td></tr><tr class="e"><td class="line_num">105</td><td >}</td></tr></table>
</body>
</html>
